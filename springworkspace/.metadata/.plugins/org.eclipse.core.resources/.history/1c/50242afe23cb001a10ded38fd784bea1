package com.spring.board.aop;

import java.io.IOException;
import java.util.HashMap;

import javax.servlet.RequestDispatcher;
import javax.servlet.ServletException;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;

import org.aspectj.lang.JoinPoint;
import org.aspectj.lang.annotation.After;
import org.aspectj.lang.annotation.Around;
import org.aspectj.lang.annotation.Aspect;
import org.aspectj.lang.annotation.Before;
import org.aspectj.lang.annotation.Pointcut;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import com.spring.common.MyUtil;
import com.spring.service.InterBoardService;

//=== #53. 공통관심사 클래스(Aspect 클래스) 생성 === //

/* LoginCheck랑  PointPlus 합침 */

@Aspect		// 공통관심사 클래스 객체로 등록
@Component	// bean으로 등록
public class BoardAOP {
	
	// ============ Before Advice 만들기 ============
	
	/*
	  주업무(글쓰기, 글수정, 댓글쓰기,...)를 실행하기 전 로그인을 해야함.
	  업무에 대한 보조업무(로그인) 객체로 로그인 여부를 체크하는 관심클래스(Aspect클래스)를 생성하여
	  포인트컷(주업무)과 어드바이스(보조업무)가 동작하도록 한다.
	 */

	// Pointcut(주업무) 생성 
	// Pointcut: 공통관심사를 필요로 하는 메소드
	//											↓패키지 끝명  ↓이걸로 시작하는 메소드 ↓파라미터 갯수 상관x
	@Pointcut("execution(public * com.spring..*Controller.requiredLogin_*(..) )")
	//						      ↑패키지 시작명↑갯수상관없이 아무거나 들어와도됨
	public void requireLogin() {}
	
	
	// Before Advice(공통관심사, 보조업무)를 구현
	@Before("requireLogin()")
	public void checkLogin(JoinPoint joinPoint) {
		// JoinPoint: 포인트컷 되어진 주업무의 메소드
		
		// 로그인 유무를 확인하기 위해 request를 통해 session을 얻어와야함
		HttpServletRequest request = (HttpServletRequest) joinPoint.getArgs()[0]; // 주업무 메소드의 첫 번째 파라미터
		HttpServletResponse response = (HttpServletResponse) joinPoint.getArgs()[1]; // 주업무 메소드의 두 번째 파라미터
		
		HttpSession session = request.getSession();
		
		if(session.getAttribute("loginuser") == null) {
			String msg = "먼저 로그인 하세요!";
			String loc = request.getContextPath()+"/login.action";
			request.setAttribute("msg", msg);
			request.setAttribute("loc", loc);
			
			String url = MyUtil.getCurrentURL(request);	
			
			// "문자열"에서 "찾고자하는 문자열"이 없으면 false를 반환
			if(url.endsWith("?null")) {
				url = url.substring(0, url.indexOf("?"));
			}
			
			session.setAttribute("gobackURL", url); // 세션에 url 정보를 저장
			
			RequestDispatcher dispatcher = request.getRequestDispatcher("/WEB-INF/views/msg.jsp");
			
			try {
				dispatcher.forward(request, response);
			} catch (ServletException | IOException e) {
				e.printStackTrace();
			}
			
		}
	} // end of public void checkLogin(JoinPoint joinPoint) -------------


	
	// ============ After Advice 만들기 ============
	@Autowired
	InterBoardService service;
	
	// Pointcut(주업무) 생성
	// Pointcut: 공통관심사를 필요로 하는 메소드
	@Pointcut("execution(public * com.spring..*Controller.pointPlus_*(..) )")
	   public void pointPlus() {}
	
	// After Advice(공통관심사,보조업무)
	@SuppressWarnings("unchecked")  // 앞으로는 노란줄 경고 표시 하지 않겠다는 뜻
	@After("pointPlus()")
	public void userPointPlus(JoinPoint joinPoint) {
		// JoinPoint joinPoint는 포인트컷 되어진 주업무의 메소드이다.
		
		HashMap<String, String> paraMap = (HashMap<String, String>) joinPoint.getArgs()[0];
		
		service.pointPlus(paraMap);
	}

	
	// ============ Around Advice 만들기 ============
	/*
	 	Before ---> 보조업무1
	 	주업무
	 	After ---> 보조업무2
	 	
	 	보조업무1 + 보조업무2를 실행하도록 해주는 것이 Around Advice 이다.
	 	
	 */
	// Pointcut(주업무) 생성 
	// Pointcut: 공통관심사를 필요로 하는 메소드
	// Pointcut 생성시 public은 생략이 가능하다. 접근제한자를 생략하면 public이 있는 것으로 간주
	// 왜냐하면 외부에서 특정 메소드에 접근을 해야 하므로 접근 제한자는 무조건 public이어야 하기 때문이다.
	@Pointcut("execution(public * com.spring..*Controller.requiredLogin_*() )")
	public void pcut() {}
	
	// After Advice(공통관심사,보조업무)를 구현한다.
	// 주업무를 실행해서 마치는데까지 걸리는 시간을 측정하는 것을 보조업무로 보겠다.
	@Around("pcut()")
		   /*주업무*/
	public Object speedMeasurement() {
		
		
		
		return null;
		
	}
	
	
}
